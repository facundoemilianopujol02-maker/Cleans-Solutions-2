<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Clean Solutions - Admin Pro</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>

    <div class="franjaSuperior">
        <div class="logo">Clean Solutions</div>
        <button id="btnAbrirLogin" class="btn-main">üîë Admin</button>

        <div id="panelControlAdmin" class="admin-panel" style="display: none;">
            <button onclick="prepararFormulario('add')" class="btn-admin btn-add">‚ûï Agregar</button>
            <button id="btnToggleDelete" onclick="toggleModoEliminar()" class="btn-admin btn-mode">üóëÔ∏è Eliminar: OFF</button>
            <button onclick="cerrarSesion()" class="btn-admin btn-logout">üö™ Salir</button>
        </div>
    </div>

    <div class="container">
        <div id="productosContainer" class="grid-productos">
            <p>Cargando cat√°logo...</p>
        </div>
    </div>

    <div id="modalProducto" class="modal">
        <div class="modal-content">
            <h3 id="modalTitulo">Nuevo Producto</h3>
            <form id="formNuevoProducto">
                <input type="text" id="id_prod" placeholder="ID (Ej: COD-01)" required>
                <input type="text" id="nombre_prod" placeholder="Nombre" required>
                <input type="number" id="precio_prod" placeholder="Precio ($)" required>
                <input type="url" id="img_prod" placeholder="URL de imagen">
                <textarea id="desc_prod" placeholder="Descripci√≥n"></textarea>
                <div class="modal-buttons">
                    <button type="button" onclick="cerrarModal('modalProducto')" class="btn-cancel">Cancelar</button>
                    <button type="submit" id="btnGuardarForm" class="btn-confirm">Guardar</button>
                </div>
            </form>
        </div>
    </div>

    <div id="modalLogin" class="modal">
        <div class="modal-content">
            <h3>Acceso Admin</h3>
            <input type="password" id="passInput" placeholder="Contrase√±a">
            <div class="modal-buttons">
                <button onclick="cerrarModal('modalLogin')">Cancelar</button>
                <button onclick="verificarPassword()" class="btn-confirm">Entrar</button>
            </div>
            <p id="errorMsg" style="color:red; display:none; margin-top:10px;">‚ùå Incorrecto</p>
        </div>
    </div>

    <script>
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbx4GzLzLS7Ty8xp9TT7iOdHzpOvlIqQbCdhfZ2TQJjbg2xvHic7t6M5eLXWiBmhiXvo/exec';
        let modoEliminar = false;
        let modoFormulario = 'add'; // Puede ser 'add' o 'edit'

        function actualizarInterfaz() {
            const esAdmin = localStorage.getItem('cleanAdmin') === 'true';
            document.getElementById('btnAbrirLogin').style.display = esAdmin ? 'none' : 'block';
            document.getElementById('panelControlAdmin').style.display = esAdmin ? 'flex' : 'none';
        }

        function abrirModal(id) { document.getElementById(id).style.display = 'flex'; }
        function cerrarModal(id) { document.getElementById(id).style.display = 'none'; }

        // --- PREPARAR FORMULARIO PARA EDITAR O AGREGAR ---
        function prepararFormulario(modo, data = null) {
            modoFormulario = modo;
            const titulo = document.getElementById('modalTitulo');
            const idInput = document.getElementById('id_prod');
            
            document.getElementById('formNuevoProducto').reset();
            idInput.disabled = false;

            if (modo === 'edit') {
                titulo.textContent = 'üìù Editar Producto';
                idInput.value = data.id;
                idInput.disabled = true; // El ID no se debe cambiar al editar
                document.getElementById('nombre_prod').value = data.nombre;
                document.getElementById('precio_prod').value = data.precio;
                document.getElementById('img_prod').value = data.imagen;
                document.getElementById('desc_prod').value = data.descripcion;
            } else {
                titulo.textContent = '‚ûï Nuevo Producto';
            }
            abrirModal('modalProducto');
        }

        // --- CARGAR PRODUCTOS ---
        function renderizar() {
            const s = document.createElement('script');
            s.src = `${SCRIPT_URL}?action=get&callback=callbackData`;
            document.body.appendChild(s);
        }

        window.callbackData = function(data) {
            const box = document.getElementById('productosContainer');
            box.innerHTML = '';
            const isAdmin = localStorage.getItem('cleanAdmin') === 'true';

            data.productos.forEach(p => {
                const card = document.createElement('div');
                card.className = 'producto-card';
                card.innerHTML = `
                    <div class="img-wrapper"><img src="${p.imagen || 'https://via.placeholder.com/200'}"></div>
                    <div class="info">
                        <h4>${p.nombre}</h4>
                        <p class="precio">$${p.precio}</p>
                        ${isAdmin ? `
                            <div class="admin-actions-card">
                                <button onclick='prepararFormulario("edit", ${JSON.stringify(p)})' class="btn-edit-card">Editar</button>
                                <button onclick="borrar('${p.id}')" class="btn-borrar-card">Eliminar</button>
                            </div>
                        ` : ''}
                    </div>
                `;
                box.appendChild(card);
            });
        }

        // --- LOGIN / LOGOUT ---
        function verificarPassword() {
            if (document.getElementById('passInput').value === 'Ragnar2025') {
                localStorage.setItem('cleanAdmin', 'true');
                cerrarModal('modalLogin');
                actualizarInterfaz();
                renderizar();
            } else { document.getElementById('errorMsg').style.display = 'block'; }
        }

        function cerrarSesion() {
            localStorage.removeItem('cleanAdmin');
            actualizarInterfaz();
            renderizar();
        }

        function toggleModoEliminar() {
            modoEliminar = !modoEliminar;
            document.body.classList.toggle('delete-mode-active', modoEliminar);
            document.getElementById('btnToggleDelete').textContent = modoEliminar ? 'üóëÔ∏è Eliminar: ON' : 'üóëÔ∏è Eliminar: OFF';
        }

        // --- ENVIAR DATOS (ADD o EDIT) ---
        document.getElementById('formNuevoProducto').onsubmit = function(e) {
            e.preventDefault();
            const btn = document.getElementById('btnGuardarForm');
            btn.disabled = true;
            btn.textContent = 'Enviando...';

            const params = new URLSearchParams({
                action: modoFormulario,
                id: document.getElementById('id_prod').value,
                nombre: document.getElementById('nombre_prod').value,
                precio: document.getElementById('precio_prod').value,
                imagen: document.getElementById('img_prod').value,
                descripcion: document.getElementById('desc_prod').value,
                callback: 'finalizarAccion'
            });

            const s = document.createElement('script');
            s.src = `${SCRIPT_URL}?${params.toString()}`;
            document.body.appendChild(s);
        };

        window.finalizarAccion = function(res) {
            alert(res.message || res.error);
            cerrarModal('modalProducto');
            document.getElementById('btnGuardarForm').disabled = false;
            document.getElementById('btnGuardarForm').textContent = 'Guardar';
            renderizar();
        }

        window.borrar = function(id) {
            if(confirm('¬øEliminar?')) {
                const s = document.createElement('script');
                s.src = `${SCRIPT_URL}?action=delete&id=${id}&callback=finalizarAccion`;
                document.body.appendChild(s);
            }
        }

        actualizarInterfaz();
        renderizar();
    </script>
</body>
</html>

