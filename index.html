<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Clean Solutions - Productos</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: Arial, sans-serif; }
        body { background: #f5f5f5; }
        
        .header { background: white; padding: 15px; display: flex; align-items: center; gap: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .admin-btn { background: #e74c3c; color: white; border: none; padding: 10px 15px; border-radius: 5px; cursor: pointer; }
        .logo { height: 40px; }
        
        .search-box { flex: 1; display: flex; }
        .search-input { flex: 1; padding: 10px; border: 1px solid #ddd; }
        .search-btn { background: #3498db; color: white; border: none; padding: 10px 15px; cursor: pointer; }
        
        .admin-panel { display: none; gap: 10px; }
        .panel-btn { background: #2ecc71; color: white; border: none; padding: 8px 12px; border-radius: 5px; cursor: pointer; }
        .logout-btn { background: #7f8c8d; }
        
        .main { padding: 20px; max-width: 1200px; margin: 0 auto; }
        .title { text-align: center; margin: 20px 0; color: #2c3e50; }
        
        .products-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 20px; }
        .product-card { background: white; border-radius: 8px; padding: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .product-name { font-size: 18px; margin-bottom: 10px; color: #2c3e50; }
        .product-price { font-size: 20px; color: #e74c3c; font-weight: bold; margin-bottom: 10px; }
        .product-id { color: #95a5a6; font-size: 12px; }
        
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); align-items: center; justify-content: center; }
        .modal-content { background: white; padding: 20px; border-radius: 8px; width: 90%; max-width: 400px; }
        .form-group { margin-bottom: 15px; }
        .form-group input, .form-group textarea { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; }
        .modal-buttons { display: flex; gap: 10px; margin-top: 20px; }
        .modal-btn { flex: 1; padding: 10px; border: none; border-radius: 5px; cursor: pointer; }
        .btn-success { background: #2ecc71; color: white; }
        .btn-cancel { background: #95a5a6; color: white; }
        
        .alert { padding: 10px; border-radius: 5px; margin: 10px 0; display: none; }
        .alert-success { background: #d4edda; color: #155724; }
        .alert-error { background: #f8d7da; color: #721c24; }
        
        @media (max-width: 768px) {
            .header { flex-direction: column; }
            .admin-panel { width: 100%; justify-content: center; }
        }
    </style>
</head>
<body>
    <header class="header">
        <button id="btnAdmin" class="admin-btn">üîí Admin</button>
        <img src="logocleans.jpg" alt="Logo" class="logo" onerror="this.style.display='none'">
        
        <div class="search-box">
            <input type="text" class="search-input" id="inputBusqueda" placeholder="Buscar productos...">
            <button class="search-btn" id="btnBuscar">üîç</button>
        </div>
        
        <div id="panelAdmin" class="admin-panel">
            <button id="btnAgregar" class="panel-btn">‚ûï Agregar</button>
            <button id="btnCerrarAdmin" class="panel-btn logout-btn">üö™ Salir</button>
        </div>
    </header>

    <main class="main">
        <h1 class="title">Productos de Limpieza</h1>
        
        <div id="alertContainer" class="alert"></div>
        
        <div id="contenedorProductos" class="products-grid">
            <!-- Los productos se cargan aqu√≠ -->
        </div>
    </main>

    <!-- MODAL CONTRASE√ëA -->
    <div id="modalPassword" class="modal">
        <div class="modal-content">
            <h3>Acceso Administrador</h3>
            <div class="form-group">
                <input type="password" id="inputPassword" placeholder="Contrase√±a">
            </div>
            <div class="modal-buttons">
                <button id="btnAcceder" class="modal-btn btn-success">Acceder</button>
                <button id="btnCancelar" class="modal-btn btn-cancel">Cancelar</button>
            </div>
            <p id="mensajeError" style="color: red; display: none; margin-top: 10px;"></p>
        </div>
    </div>

    <!-- MODAL AGREGAR PRODUCTO -->
    <div id="modalProducto" class="modal">
        <div class="modal-content">
            <h3>Nuevo Producto</h3>
            <form id="productForm">
                <div class="form-group">
                    <input type="text" id="id" placeholder="ID *" required>
                </div>
                <div class="form-group">
                    <input type="text" id="nombre" placeholder="Nombre *" required>
                </div>
                <div class="form-group">
                    <input type="number" id="precio" placeholder="Precio *" required step="0.01">
                </div>
                <div class="form-group">
                    <textarea id="descripcion" placeholder="Descripci√≥n" rows="3"></textarea>
                </div>
                <div class="modal-buttons">
                    <button type="submit" id="btnGuardar" class="modal-btn btn-success">Guardar</button>
                    <button type="button" id="cancelarForm" class="modal-btn btn-cancel">Cancelar</button>
                </div>
            </form>
            <div id="message" class="alert" style="margin-top: 15px;"></div>
        </div>
    </div>

    <script>
        // CONFIGURACI√ìN
        const PASSWORD = 'Ragnar2025';
        const API_URL = 'https://script.google.com/macros/s/AKfycbyq2248weIB7j7srhx8NPTmPPOi5s_d0Avu-CKpehpPCuqdweqp83m2gOHDWKeNFs68/exec';
        
        // VARIABLES
        let productos = [];
        
        // INICIAR
        document.addEventListener('DOMContentLoaded', function() {
            console.log('‚úÖ Sistema listo');
            
            if (localStorage.getItem('adminActive') === 'true') {
                activarAdmin();
            }
            
            cargarProductos();
            configurarEventos();
        });
        
        // FUNCIONES
        
        // 1. CARGAR PRODUCTOS (GET normal)
        async function cargarProductos() {
            try {
                console.log('üì• Cargando productos...');
                mostrarMensaje('Cargando productos...', 'info');
                
                const response = await fetch(API_URL + '?t=' + Date.now());
                const data = await response.json();
                
                console.log('üì¶ Datos recibidos:', data);
                
                if (data.success && data.productos) {
                    productos = data.productos;
                    mostrarProductos(productos);
                    mostrarMensaje(`${productos.length} productos cargados`, 'success');
                } else {
                    throw new Error(data.error || 'Error al cargar');
                }
                
            } catch(error) {
                console.error('‚ùå Error:', error);
                mostrarMensaje('Error al cargar productos', 'error');
                mostrarProductos([]);
            }
        }
        
        // 2. AGREGAR PRODUCTO (POST simple)
        async function agregarProducto(productData) {
            console.log('üì§ Enviando producto:', productData);
            
            try {
                // Usar FormData para evitar CORS
                const formData = new FormData();
                formData.append('id', productData.id);
                formData.append('nombre', productData.nombre);
                formData.append('precio', productData.precio);
                formData.append('imagen', productData.imagen || '');
                formData.append('descripcion', productData.descripcion || '');
                
                // Enviar como POST
                const response = await fetch(API_URL, {
                    method: 'POST',
                    body: formData,
                    mode: 'no-cors' // Esto evita problemas de CORS
                });
                
                // Con no-cors no podemos leer la respuesta, pero sabemos que se envi√≥
                console.log('‚úÖ Petici√≥n enviada (no-cors)');
                
                // Retornar √©xito (en producci√≥n deber√≠as usar JSONP para leer respuesta)
                return { success: true, message: 'Producto enviado al servidor' };
                
            } catch(error) {
                console.error('‚ùå Error:', error);
                throw error;
            }
        }
        
        // 3. AGREGAR PRODUCTO CON JSONP (alternativa)
        function agregarProductoJsonp(productData) {
            return new Promise((resolve, reject) => {
                const callbackName = 'callback_' + Date.now();
                
                // Crear URL con par√°metros
                const params = new URLSearchParams();
                params.append('id', productData.id);
                params.append('nombre', productData.nombre);
                params.append('precio', productData.precio);
                params.append('imagen', productData.imagen || '');
                params.append('descripcion', productData.descripcion || '');
                params.append('callback', callbackName);
                
                const script = document.createElement('script');
                script.src = API_URL + '?' + params.toString();
                
                window[callbackName] = function(response) {
                    delete window[callbackName];
                    document.body.removeChild(script);
                    
                    if (response.success) {
                        resolve(response);
                    } else {
                        reject(new Error(response.error));
                    }
                };
                
                script.onerror = function() {
                    delete window[callbackName];
                    document.body.removeChild(script);
                    reject(new Error('Error de red'));
                };
                
                document.body.appendChild(script);
                
                setTimeout(() => {
                    if (window[callbackName]) {
                        delete window[callbackName];
                        document.body.removeChild(script);
                        reject(new Error('Timeout'));
                    }
                }, 10000);
            });
        }
        
        // 4. MOSTRAR PRODUCTOS
        function mostrarProductos(lista) {
            const container = document.getElementById('contenedorProductos');
            
            if (!lista || lista.length === 0) {
                container.innerHTML = `
                    <div style="grid-column: 1/-1; text-align: center; padding: 40px; color: #666;">
                        <p>No hay productos disponibles</p>
                        <p><small>Agrega productos desde el panel de administraci√≥n</small></p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = lista.map(p => `
                <div class="product-card">
                    <h3 class="product-name">${p.nombre || 'Sin nombre'}</h3>
                    <p class="product-price">$${parseFloat(p.precio || 0).toFixed(2)}</p>
                    <p>${p.descripcion || 'Sin descripci√≥n'}</p>
                    <p class="product-id">ID: ${p.id || 'N/A'}</p>
                </div>
            `).join('');
        }
        
        // FUNCIONES AUXILIARES
        function mostrarMensaje(texto, tipo = 'info') {
            const container = document.getElementById('alertContainer');
            container.textContent = texto;
            container.className = `alert alert-${tipo}`;
            container.style.display = 'block';
            
            if (tipo === 'success') {
                setTimeout(() => container.style.display = 'none', 3000);
            }
        }
        
        function activarAdmin() {
            document.getElementById('panelAdmin').style.display = 'flex';
            document.getElementById('btnAdmin').style.display = 'none';
            localStorage.setItem('adminActive', 'true');
        }
        
        function desactivarAdmin() {
            document.getElementById('panelAdmin').style.display = 'none';
            document.getElementById('btnAdmin').style.display = 'block';
            localStorage.removeItem('adminActive');
            cerrarModal('modalProducto');
        }
        
        function abrirModal(id) {
            document.getElementById(id).style.display = 'flex';
        }
        
        function cerrarModal(id) {
            document.getElementById(id).style.display = 'none';
            if (id === 'modalPassword') {
                document.getElementById('inputPassword').value = '';
                document.getElementById('mensajeError').style.display = 'none';
            }
            if (id === 'modalProducto') {
                document.getElementById('productForm').reset();
                document.getElementById('message').style.display = 'none';
            }
        }
        
        // EVENTOS
        function configurarEventos() {
            // Admin
            document.getElementById('btnAdmin').addEventListener('click', () => {
                abrirModal('modalPassword');
                document.getElementById('inputPassword').focus();
            });
            
            // Acceder
            document.getElementById('btnAcceder').addEventListener('click', () => {
                const pass = document.getElementById('inputPassword').value;
                const errorMsg = document.getElementById('mensajeError');
                
                if (pass === PASSWORD) {
                    activarAdmin();
                    cerrarModal('modalPassword');
                    mostrarMensaje('Modo admin activado', 'success');
                } else {
                    errorMsg.textContent = 'Contrase√±a incorrecta';
                    errorMsg.style.display = 'block';
                    document.getElementById('inputPassword').value = '';
                }
            });
            
            document.getElementById('btnCancelar').addEventListener('click', () => {
                cerrarModal('modalPassword');
            });
            
            // Agregar producto
            document.getElementById('btnAgregar').addEventListener('click', () => {
                cerrarModal('modalPassword');
                setTimeout(() => abrirModal('modalProducto'), 100);
            });
            
            // Cerrar sesi√≥n
            document.getElementById('btnCerrarAdmin').addEventListener('click', () => {
                if (confirm('¬øCerrar sesi√≥n?')) {
                    desactivarAdmin();
                    mostrarMensaje('Sesi√≥n cerrada', 'success');
                }
            });
            
            // Formulario
            document.getElementById('productForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const productData = {
                    id: document.getElementById('id').value.trim(),
                    nombre: document.getElementById('nombre').value.trim(),
                    precio: document.getElementById('precio').value.trim(),
                    descripcion: document.getElementById('descripcion').value.trim()
                };
                
                if (!productData.id || !productData.nombre || !productData.precio) {
                    mostrarMensaje('Completa ID, Nombre y Precio', 'error', 'message');
                    return;
                }
                
                const btn = document.getElementById('btnGuardar');
                btn.textContent = 'Enviando...';
                btn.disabled = true;
                
                mostrarMensaje('Agregando producto...', 'info', 'message');
                
                try {
                    // Intentar con JSONP primero
                    const resultado = await agregarProductoJsonp(productData);
                    
                    mostrarMensaje(resultado.message, 'success', 'message');
                    this.reset();
                    
                    setTimeout(() => {
                        cerrarModal('modalProducto');
                        cargarProductos(); // Recargar productos
                    }, 2000);
                    
                } catch(error) {
                    console.error('Error JSONP:', error);
                    
                    // Si falla JSONP, intentar con POST simple
                    try {
                        await agregarProducto(productData);
                        mostrarMensaje('Producto agregado (recarga la p√°gina)', 'success', 'message');
                        
                        setTimeout(() => {
                            cerrarModal('modalProducto');
                            location.reload(); // Recargar p√°gina completa
                        }, 2000);
                        
                    } catch(postError) {
                        mostrarMensaje('Error: ' + error.message, 'error', 'message');
                    }
                    
                } finally {
                    btn.textContent = 'Guardar';
                    btn.disabled = false;
                }
            });
            
            // Cancelar
            document.getElementById('cancelarForm').addEventListener('click', () => {
                cerrarModal('modalProducto');
            });
            
            // Cerrar modales
            document.querySelectorAll('.modal').forEach(modal => {
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) cerrarModal(modal.id);
                });
            });
            
            // B√∫squeda
            document.getElementById('btnBuscar').addEventListener('click', () => {
                const termino = document.getElementById('inputBusqueda').value.toLowerCase();
                if (!termino) {
                    mostrarProductos(productos);
                    return;
                }
                
                const filtrados = productos.filter(p => 
                    (p.nombre && p.nombre.toLowerCase().includes(termino)) ||
                    (p.descripcion && p.descripcion.toLowerCase().includes(termino)) ||
                    (p.id && p.id.toLowerCase().includes(termino))
                );
                
                mostrarProductos(filtrados);
            });
        }
    </script>
</body>
</html>
