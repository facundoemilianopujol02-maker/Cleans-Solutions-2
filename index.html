<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Clean Solutions - Cat√°logo Admin</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>

    <div class="franjaSuperior">
        <div class="logo">Clean Solutions</div>
        
        <button id="btnAdmin" class="btn-main">üîë Admin</button>

        <div id="panelAdmin" class="admin-panel" style="display: none;">
            <button onclick="prepararFormulario('add')" class="btn-admin btn-add">‚ûï Agregar</button>
            <button id="btnToggleDelete" onclick="toggleModoEliminar()" class="btn-admin btn-mode">üóëÔ∏è Borrar: OFF</button>
            <button onclick="cerrarSesion()" class="btn-admin btn-logout">üö™ Salir</button>
        </div>
    </div>

    <div class="container">
        <div id="productosContainer" class="grid-productos">
            <p>Cargando productos...</p>
        </div>
    </div>

    <div id="modalProducto" class="modal">
        <div class="modal-content">
            <h3 id="modalTitulo">Nuevo Producto</h3>
            <form id="formProducto">
                <input type="text" id="p_id" placeholder="ID (Ej: COD-01)" required>
                <input type="text" id="p_nombre" placeholder="Nombre" required>
                <input type="number" id="p_precio" placeholder="Precio ($)" required>
                <input type="url" id="p_img" placeholder="URL de imagen">
                <textarea id="p_desc" placeholder="Descripci√≥n"></textarea>
                <div class="modal-buttons">
                    <button type="button" onclick="cerrarModal('modalProducto')" class="btn-cancel">Cancelar</button>
                    <button type="submit" id="btnGuardarForm" class="btn-confirm">Guardar</button>
                </div>
            </form>
        </div>
    </div>

    <div id="modalLogin" class="modal">
        <div class="modal-content">
            <h3>Acceso Administrador</h3>
            <input type="password" id="passInput" placeholder="Contrase√±a">
            <div class="modal-buttons">
                <button onclick="cerrarModal('modalLogin')" class="btn-cancel">Cerrar</button>
                <button onclick="verificarPassword()" class="btn-confirm">Entrar</button>
            </div>
            <p id="errorLogin" style="color:red; display:none; margin-top:10px;">‚ùå Clave incorrecta</p>
        </div>
    </div>

    <script>
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwBAvY2gVqHykxIN_c0l46nJfWELdkiwn43VE2hvlZ5bmhOYMFqK_XOZA-vy4Op-3la/exec';
        let modoEliminar = false;
        let modoFormulario = 'add';
        let listaProductos = []; // Guardamos los productos para editarlos f√°cilmente

        // --- MANEJO DE VISTAS ---
        function actualizarInterfaz() {
            const logueado = localStorage.getItem('cleanAdminOK') === 'true';
            document.getElementById('btnAdmin').style.display = logueado ? 'none' : 'block';
            document.getElementById('panelAdmin').style.display = logueado ? 'flex' : 'none';
        }

        function abrirModal(id) { document.getElementById(id).style.display = 'flex'; }
        function cerrarModal(id) { document.getElementById(id).style.display = 'none'; }

        // --- LOGIN ---
        document.getElementById('btnAdmin').onclick = () => abrirModal('modalLogin');

        function verificarPassword() {
            if(document.getElementById('passInput').value === 'Ragnar2025') {
                localStorage.setItem('cleanAdminOK', 'true');
                cerrarModal('modalLogin');
                actualizarInterfaz();
                renderizar();
            } else {
                document.getElementById('errorLogin').style.display = 'block';
            }
        }

        function cerrarSesion() {
            localStorage.removeItem('cleanAdminOK');
            modoEliminar = false;
            document.body.classList.remove('delete-active');
            actualizarInterfaz();
            renderizar();
        }

        // --- FORMULARIO (ADD / EDIT) ---
        function prepararFormulario(modo, idProd = null) {
            modoFormulario = modo;
            document.getElementById('formProducto').reset();
            const idInput = document.getElementById('p_id');
            idInput.disabled = false;

            if (modo === 'edit') {
                document.getElementById('modalTitulo').textContent = 'üìù Editar Producto';
                const p = listaProductos.find(item => item.id == idProd);
                if (p) {
                    idInput.value = p.id;
                    idInput.disabled = true;
                    document.getElementById('p_nombre').value = p.nombre;
                    document.getElementById('p_precio').value = p.precio;
                    document.getElementById('p_img').value = p.imagen;
                    document.getElementById('p_desc').value = p.descripcion;
                }
            } else {
                document.getElementById('modalTitulo').textContent = '‚ûï Nuevo Producto';
            }
            abrirModal('modalProducto');
        }

        // --- CARGAR DATOS ---
        function renderizar() {
            const s = document.createElement('script');
            s.src = `${SCRIPT_URL}?action=get&callback=pintar`;
            document.body.appendChild(s);
        }

        window.pintar = function(res) {
            listaProductos = res.productos;
            const container = document.getElementById('productosContainer');
            container.innerHTML = '';
            const isAdmin = localStorage.getItem('cleanAdminOK') === 'true';

            res.productos.forEach(p => {
                const card = document.createElement('div');
                card.className = 'card';
                card.innerHTML = `
                    <img src="${p.imagen || 'https://via.placeholder.com/200'}">
                    <div class="info">
                        <h4>${p.nombre}</h4>
                        <p class="price">$${p.precio}</p>
                        ${isAdmin ? `
                            <div class="admin-btns-card">
                                <button onclick="prepararFormulario('edit', '${p.id}')" class="btn-edit-card">Editar</button>
                                <button onclick="borrar('${p.id}')" class="btn-borrar-card">Eliminar</button>
                            </div>
                        ` : ''}
                    </div>
                `;
                container.appendChild(card);
            });
        }

        // --- ACCIONES ---
        document.getElementById('formProducto').onsubmit = function(e) {
            e.preventDefault();
            const btn = document.getElementById('btnGuardarForm');
            btn.disabled = true;
            btn.textContent = 'Procesando...';

            const p = new URLSearchParams({
                action: modoFormulario,
                id: document.getElementById('p_id').value,
                nombre: document.getElementById('p_nombre').value,
                precio: document.getElementById('p_precio').value,
                imagen: document.getElementById('p_img').value,
                descripcion: document.getElementById('p_desc').value,
                callback: 'finalizar'
            });
            const s = document.createElement('script');
            s.src = `${SCRIPT_URL}?${p.toString()}`;
            document.body.appendChild(s);
        }

        window.finalizar = function(res) {
            alert(res.message || res.error);
            cerrarModal('modalProducto');
            document.getElementById('btnGuardarForm').disabled = false;
            document.getElementById('btnGuardarForm').textContent = 'Guardar';
            renderizar();
        }

        window.borrar = function(id) {
            if(!confirm('¬øEliminar producto?')) return;
            const s = document.createElement('script');
            s.src = `${SCRIPT_URL}?action=delete&id=${id}&callback=finalizar`;
            document.body.appendChild(s);
        }

        function toggleModoEliminar() {
            modoEliminar = !modoEliminar;
            document.body.classList.toggle('delete-active', modoEliminar);
            document.getElementById('btnToggleDelete').textContent = modoEliminar ? 'üóëÔ∏è Borrar: ON' : 'üóëÔ∏è Borrar: OFF';
            document.getElementById('btnToggleDelete').style.background = modoEliminar ? '#ea4335' : '#fbbc05';
        }

        // Inicio
        actualizarInterfaz();
        renderizar();
    </script>
</body>
</html>
